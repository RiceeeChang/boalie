<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>寶徠社區管理申請入口</title>
	<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
	<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
</head>
<body>
	<div id="profile">

	</div>


<script type="text/javascript">
var liffID = '1656721259-EqNJnxlB';
var loginUrl = 'https://riceeechang.github.io/boalie/';
var lineAtUrl = 'https://lin.ee/i5P97Pv';
var formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSe9qd9fyDhCmNLHWiuR9qjblX_apwe_RKUb2Wm7kqLU3JdoLg/viewform?usp=pp_url&entry.697677827=';
var dbUrl = 'https://script.google.com/macros/s/AKfycbzKjhT2nHAWVoJ5cj87VwPyI4dHCQjOln5K_LnBhpXS0t7rTuK1dOBN2Whz7N1CKYWYFQ/exec';

liff.init({
	liffId: liffID
}).then(function() {
	var isInLine = liff.isInClient();   // 回傳是否由 LINE App 存取
	if (!isInLine) {
		// 顯示請他使用手機的Line掃QRCode的方式點開
		console.log("請使用手機的Line開啟");
	}

	var isLoggedIn = liff.isLoggedIn(); // 使用者是否登入 LINE 帳號
    var context = liff.getContext();
	if (isLoggedIn) {
		liff.getProfile()
			.then(profile => {
				console.log(profile);
				// 驗證line_id是否已經加入
				fetch(dbUrl+'?line_id='+profile.userId)
				.then(function(response) {
					return response.json();
				})
				.then(function(response) {
					console.log(response);
					if (response.result == true) { // 已經加入，直接轉去Line@
						location.href = lineAtUrl;
					} else {
						var user = liff.getDecodedIDToken();

						var data = {
							userId: profile.userId,
							displayName: profile.displayName,
							email: user.email,
							pictureUrl: profile.pictureUrl
						};
						fetch(dbUrl, {
							method: 'POST',
							body: JSON.stringify(data)
						})
						.then(res => res.json())
						.then(response => {
							if (response.result == true) {
								location.href = lineAtUrl;
							}
						})
					}
				});
			})
	} else {
		liff.login({
			redirectUri: loginUrl // 使用者登入後要去到哪個頁面
		});
	}
}).catch(function(error) {
  console.log(error);
});
</script>
</body>
</html>